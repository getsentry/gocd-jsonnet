{
   "format_version": 10,
   "pipelines": {
      "deploy-example-control": {
         "display_order": 3,
         "group": "example",
         "materials": {
            "deploy-example-de-pipeline-complete": {
               "pipeline": "deploy-example-de",
               "stage": "pipeline-complete"
            },
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "control",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-customer-1": {
         "display_order": 4,
         "group": "example",
         "materials": {
            "deploy-example-control-pipeline-complete": {
               "pipeline": "deploy-example-control",
               "stage": "pipeline-complete"
            },
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "customer-1",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-customer-2": {
         "display_order": 5,
         "group": "example",
         "materials": {
            "deploy-example-customer-1-pipeline-complete": {
               "pipeline": "deploy-example-customer-1",
               "stage": "pipeline-complete"
            },
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "customer-2",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-customer-4": {
         "display_order": 6,
         "group": "example",
         "materials": {
            "deploy-example-customer-2-pipeline-complete": {
               "pipeline": "deploy-example-customer-2",
               "stage": "pipeline-complete"
            },
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "customer-4",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-customer-7": {
         "display_order": 7,
         "group": "example",
         "materials": {
            "deploy-example-customer-4-pipeline-complete": {
               "pipeline": "deploy-example-customer-4",
               "stage": "pipeline-complete"
            },
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "customer-7",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-de": {
         "display_order": 2,
         "group": "example",
         "materials": {
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "de",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "deploy-example-s4s2": {
         "display_order": 8,
         "group": "example",
         "materials": {
            "example_repo": {
               "branch": "master",
               "destination": "example",
               "git": "git@github.com:getsentry/example.git",
               "shallow_clone": true
            }
         },
         "region": "s4s2",
         "stages": [
            {
               "example_stage": { }
            },
            {
               "pipeline-complete": {
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      },
      "rollback-example": {
         "display_order": 1,
         "environment_variables": {
            "ALL_PIPELINE_FLAGS": "--pipeline=deploy-example-de --pipeline=deploy-example-control --pipeline=deploy-example-customer-1 --pipeline=deploy-example-customer-2 --pipeline=deploy-example-customer-4 --pipeline=deploy-example-customer-7",
            "GOCD_ACCESS_TOKEN": "{{SECRET:[devinfra][gocd_access_token]}}",
            "REGION_PIPELINE_FLAGS": "--pipeline=deploy-example-de --pipeline=deploy-example-control --pipeline=deploy-example-customer-1 --pipeline=deploy-example-customer-2 --pipeline=deploy-example-customer-4 --pipeline=deploy-example-customer-7",
            "ROLLBACK_MATERIAL_NAME": "example_repo",
            "ROLLBACK_STAGE": "example_stage",
            "TRIGGERED_BY": ""
         },
         "group": "example",
         "lock_behavior": "unlockWhenFinished",
         "materials": {
            "deploy-example-customer-7-pipeline-complete": {
               "pipeline": "deploy-example-customer-7",
               "stage": "pipeline-complete"
            }
         },
         "stages": [
            {
               "pause_pipelines": {
                  "approval": {
                     "type": "manual"
                  },
                  "jobs": {
                     "rollback": {
                        "elastic_profile_id": "example_profile",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n## Note: $ALL_PIPELINE_FLAGS has no quoting, for word expansion\n## shellcheck disable=SC2086\nif [[ \"${ALL_PIPELINE_FLAGS:-}\" ]]; then\n  set -- $ALL_PIPELINE_FLAGS\nfi\n\n## The user that triggered the rollback\nTRIGGERED_BY=\"${TRIGGERED_BY:-}\"\n\npause_message='This pipeline is being rolled back, please check with team before un-pausing.'\n\n## Include triggered by in the pause message if it is not empty\nif [ -n \"$TRIGGERED_BY\" ]; then\n  pause_message=\"$pause_message Triggered by: $TRIGGERED_BY\"\nfi\n\n## Pause all pipelines in the pipedream\ngocd-pause-and-cancel-pipelines \\\n  --pause-message=\"$pause_message\" \\\n  \"$@\"\n"
                           }
                        ]
                     }
                  }
               }
            },
            {
               "start_rollback": {
                  "jobs": {
                     "rollback": {
                        "elastic_profile_id": "example_profile",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n## Note: $REGION_PIPELINE_FLAGS has no quoting, for word expansion\n## shellcheck disable=SC2086\nif [[ \"${REGION_PIPELINE_FLAGS:-}\" ]]; then\n  set -- $REGION_PIPELINE_FLAGS\nfi\n\n## The user that triggered the rollback\nTRIGGERED_BY=\"${TRIGGERED_BY:-}\"\n\npause_message='This pipeline was rolled back, please check with team before un-pausing.'\n\n## Include triggered by in the pause message if it is not empty\nif [ -n \"$TRIGGERED_BY\" ]; then\n  pause_message=\"$pause_message Triggered by: $TRIGGERED_BY\"\nfi\n\n## Get sha from the given pipeline run to deploy to all pipedream pipelines.\nsha=$(gocd-sha-for-pipeline --material-name=\"${ROLLBACK_MATERIAL_NAME}\")\n\necho \"📑 Rolling back to sha: ${sha}\"\n\ngocd-emergency-deploy \\\n  --material-name=\"${ROLLBACK_MATERIAL_NAME}\" \\\n  --commit-sha=\"${sha}\" \\\n  --deploy-stage=\"${ROLLBACK_STAGE}\" \\\n  --pause-message=\"$pause_message\" \\\n  \"$@\"\n"
                           }
                        ]
                     }
                  }
               }
            },
            {
               "incident_resolved": {
                  "approval": {
                     "type": "manual"
                  },
                  "jobs": {
                     "rollback": {
                        "elastic_profile_id": "example_profile",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n## Note: $ALL_PIPELINE_FLAGS has no quoting, for word expansion\n## shellcheck disable=SC2086\nif [[ \"${ALL_PIPELINE_FLAGS:-}\" ]]; then\n  set -- $ALL_PIPELINE_FLAGS\nfi\n\n## Unpause and unlock all pipelines in the pipedream\ngocd-unpause-and-unlock-pipelines \\\n  \"$@\"\n"
                           }
                        ]
                     }
                  }
               }
            }
         ]
      }
   }
}
